<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1e3a5f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AFERTES - Portail de Formation</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="./manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --blue: #1e3a5f;
            --blue-light: #2d5a8a;
            --pink: #e84e8a;
            --green: #10b981;
            --orange: #f59e0b;
            --red: #ef4444;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-500: #64748b;
            --gray-700: #334155;
            --gray-900: #0f172a;
        }
        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--gray-50); color: var(--gray-900); line-height: 1.5; }
        
        /* Header */
        header { background: linear-gradient(135deg, var(--blue) 0%, var(--blue-light) 100%); color: white; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.75rem; text-decoration: none; color: white; }
        .logo img { height: 40px; }
        .logo-text { font-size: 1.25rem; font-weight: 700; }
        .logo-sub { font-size: 0.7rem; opacity: 0.8; }
        .header-user { display: flex; align-items: center; gap: 0.75rem; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.4rem; }
        .btn-white { background: white; color: var(--blue); }
        .btn-white:hover { background: var(--gray-100); }
        .btn-pink { background: var(--pink); color: white; }
        .btn-pink:hover { opacity: 0.9; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-ghost { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        
        /* Main */
        main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        /* Cards */
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--gray-100); flex-wrap: wrap; gap: 0.5rem; }
        .card-title { font-size: 1.1rem; font-weight: 700; color: var(--blue); }
        
        /* Welcome */
        .welcome { background: linear-gradient(135deg, var(--blue) 0%, var(--blue-light) 100%); color: white; border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; }
        .welcome h1 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .welcome p { opacity: 0.9; }
        .welcome-badges { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-light { background: rgba(255,255,255,0.2); color: white; }
        
        /* Auth */
        .auth-container { max-width: 420px; margin: 2rem auto; }
        .auth-logo { text-align: center; margin-bottom: 1.5rem; }
        .auth-logo img { height: 50px; margin-bottom: 0.5rem; }
        .auth-logo h2 { color: var(--blue); font-size: 1.5rem; }
        .auth-tabs { display: flex; background: var(--gray-100); border-radius: 10px; padding: 4px; margin-bottom: 1.5rem; }
        .auth-tab { flex: 1; padding: 0.6rem; text-align: center; border: none; background: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--gray-500); transition: all 0.2s; }
        .auth-tab.active { background: white; color: var(--blue); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        
        /* Forms */
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.4rem; font-size: 0.875rem; color: var(--gray-700); }
        .form-label .req { color: var(--pink); }
        .form-input, .form-select { width: 100%; padding: 0.75rem; border: 2px solid var(--gray-200); border-radius: 8px; font-size: 1rem; transition: border-color 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--blue); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-help { font-size: 0.75rem; color: var(--gray-500); margin-top: 0.25rem; }
        .form-submit { width: 100%; padding: 0.875rem; background: var(--blue); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 0.5rem; }
        .form-submit:hover { background: var(--blue-light); }
        
        /* Alert */
        .alert { padding: 0.875rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0.25rem; background: white; padding: 0.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex-wrap: wrap; }
        .tab { padding: 0.6rem 1rem; border: none; background: none; border-radius: 8px; font-weight: 500; cursor: pointer; color: var(--gray-500); transition: all 0.2s; font-size: 0.875rem; }
        .tab.active { background: var(--blue); color: white; }
        .tab:hover:not(.active) { background: var(--gray-100); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--gray-100); }
        th { background: var(--blue); color: white; font-weight: 600; }
        th:first-child { border-radius: 8px 0 0 0; }
        th:last-child { border-radius: 0 8px 0 0; }
        tr:hover td { background: var(--gray-50); }
        .grade { padding: 0.2rem 0.5rem; border-radius: 6px; font-weight: 600; font-size: 0.8rem; }
        .grade-good { background: #d1fae5; color: var(--green); }
        .grade-ok { background: #fef3c7; color: var(--orange); }
        .grade-bad { background: #fee2e2; color: var(--red); }
        
        /* Tags */
        .tag { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.7rem; font-weight: 600; margin-right: 0.25rem; }
        .tag-es { background: #d1fae5; color: #065f46; }
        .tag-me { background: #dbeafe; color: #1e40af; }
        .tag-aes { background: #fef3c7; color: #92400e; }
        .tag-caferuis { background: #fce7f3; color: #9d174d; }
        .tag-cafdes { background: #ede9fe; color: #5b21b6; }
        .tag-slb { background: #e0e7ff; color: #3730a3; }
        .tag-avion { background: #fce7f3; color: #9d174d; }
        
        /* List items */
        .list-item { padding: 1rem; border-bottom: 1px solid var(--gray-100); display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: var(--gray-50); }
        .list-empty { text-align: center; padding: 2rem; color: var(--gray-500); }
        
        /* News */
        .news-item { padding: 1rem 0; border-bottom: 1px solid var(--gray-100); }
        .news-item:last-child { border-bottom: none; }
        .news-title { font-weight: 600; color: var(--blue); margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .news-content { color: var(--gray-700); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .news-meta { font-size: 0.75rem; color: var(--gray-500); display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .news-img { width: 100px; height: 70px; object-fit: cover; border-radius: 8px; margin-right: 1rem; float: left; }
        
        /* Quick actions */
        .quick-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem; }
        .quick-btn { padding: 1rem; background: var(--gray-50); border: 2px solid var(--gray-100); border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .quick-btn:hover { border-color: var(--blue); background: white; transform: translateY(-2px); }
        .quick-btn .icon { font-size: 1.5rem; margin-bottom: 0.4rem; }
        .quick-btn .label { font-size: 0.8rem; font-weight: 500; color: var(--gray-700); }
        
        /* Filters */
        .filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; align-items: center; gap: 0.5rem; }
        .filter-group label { font-size: 0.8rem; font-weight: 500; }
        .filter-group select { padding: 0.4rem 0.75rem; border: 2px solid var(--gray-200); border-radius: 6px; font-size: 0.85rem; }
        
        /* Profile */
        .profile-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; background: linear-gradient(135deg, var(--blue), var(--pink)); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: 700; flex-shrink: 0; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info h3 { font-size: 1.2rem; color: var(--blue); }
        .profile-info p { color: var(--gray-500); font-size: 0.9rem; }
        .profile-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        
        /* Image upload */
        .img-upload { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 8px; }
        .img-preview { width: 80px; height: 60px; background: var(--gray-200); border-radius: 6px; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .img-upload-btn { padding: 0.5rem 1rem; background: var(--blue); color: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
        .img-upload input { display: none; }
        
        /* Settings */
        .settings-section { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--gray-100); }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h4 { color: var(--blue); margin-bottom: 1rem; }
        
        /* Chips */
        .chips { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; }
        .chip { padding: 0.4rem 0.75rem; background: var(--gray-100); border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .chip:hover { background: var(--gray-200); }
        .chip.selected { background: #dbeafe; border-color: var(--blue); color: var(--blue); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; padding: 1rem; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: white; border-radius: 12px; padding: 1.5rem; max-width: 420px; width: 100%; max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { color: var(--blue); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray-500); }
        
        /* File list */
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--gray-50); border-radius: 8px; margin-bottom: 0.5rem; }
        .file-info { display: flex; align-items: center; gap: 0.75rem; }
        .file-icon { font-size: 1.25rem; }
        
        /* Delete btn */
        .btn-delete { background: var(--red); color: white; padding: 0.3rem 0.6rem; font-size: 0.75rem; }
        
        /* Responsive */
        @media (max-width: 640px) {
            .form-row { grid-template-columns: 1fr; }
            .header-content { justify-content: center; text-align: center; }
            .profile-form { grid-template-columns: 1fr; }
            table { font-size: 0.75rem; }
            th, td { padding: 0.5rem; }
        }
        
        /* Hidden */
        .hidden { display: none !important; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--gray-100); }
        ::-webkit-scrollbar-thumb { background: var(--gray-300); border-radius: 3px; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <a href="https://afertes.org" target="_blank" class="logo">
            <img src="https://afertes.org/wp-content/uploads/2024/12/cropped-Afertes-logo-175x56.png" alt="AFERTES" onerror="this.style.display='none'">
            <div>
                <div class="logo-text">AFERTES</div>
                <div class="logo-sub">Centre de formation en travail social</div>
            </div>
        </a>
        <div class="header-user" id="header-user"></div>
    </div>
</header>

<main>
    <!-- AUTH -->
    <div id="auth-view" class="auth-container">
        <div class="card">
            <div class="auth-logo">
                <img src="https://afertes.org/wp-content/uploads/2024/12/cropped-Afertes-logo-175x56.png" alt="AFERTES" onerror="this.style.display='none'">
                <h2>Portail de Formation</h2>
                <p style="color:var(--gray-500);font-size:0.9rem;">Ann√©e 2024-2025</p>
            </div>
            
            <div id="auth-alert"></div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Connexion</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Inscription</button>
            </div>
            
            <!-- LOGIN -->
            <form id="login-form" class="auth-form active" onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">Email <span class="req">*</span></label>
                    <input type="email" class="form-input" id="login-email" required placeholder="votre@email.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe <span class="req">*</span></label>
                    <input type="password" class="form-input" id="login-password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <p style="text-align:right;margin-bottom:1rem;"><a href="#" onclick="showForgotPw()" style="color:var(--blue);font-size:0.85rem;">Mot de passe oubli√© ?</a></p>
                <button type="submit" class="form-submit">Se connecter</button>
            </form>
            
            <!-- REGISTER -->
            <form id="register-form" class="auth-form" onsubmit="register(event)">
                <div id="reg-step1">
                    <p style="font-weight:500;margin-bottom:1rem;">Je suis :</p>
                    <div class="form-row">
                        <div class="quick-btn" onclick="selectUserType('student')" data-type="student">
                            <div class="icon">üéì</div>
                            <div class="label">√âtudiant</div>
                        </div>
                        <div class="quick-btn" onclick="selectUserType('teacher')" data-type="teacher">
                            <div class="icon">üë®‚Äçüè´</div>
                            <div class="label">Formateur</div>
                        </div>
                    </div>
                    <button type="button" class="form-submit" onclick="nextRegStep()" id="next-btn" disabled style="margin-top:1rem;">Continuer ‚Üí</button>
                </div>
                
                <div id="reg-step2" class="hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Pr√©nom <span class="req">*</span></label>
                            <input type="text" class="form-input" id="reg-prenom" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nom <span class="req">*</span></label>
                            <input type="text" class="form-input" id="reg-nom" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email <span class="req">*</span></label>
                        <input type="email" class="form-input" id="reg-email" required placeholder="votre@email.com">
                        <p class="form-help">Utilis√© pour la connexion et r√©cup√©ration du mot de passe</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√©l√©phone</label>
                        <input type="tel" class="form-input" id="reg-tel" placeholder="06 XX XX XX XX">
                    </div>
                    
                    <!-- Student fields -->
                    <div id="student-fields">
                        <div class="form-group">
                            <label class="form-label">Promotion <span class="req">*</span></label>
                            <select class="form-select" id="reg-promo" required></select>
                        </div>
                    </div>
                    
                    <!-- Teacher fields -->
                    <div id="teacher-fields" class="hidden">
                        <div class="form-group">
                            <label class="form-label">Sites d'intervention</label>
                            <div class="chips" id="teacher-sites">
                                <span class="chip" data-val="SLB" onclick="toggleChip(this)">üìç Saint-Laurent-Blangy</span>
                                <span class="chip" data-val="Avion" onclick="toggleChip(this)">üìç Avion</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Mot de passe <span class="req">*</span></label>
                        <input type="password" class="form-input" id="reg-password" required minlength="6" placeholder="Minimum 6 caract√®res">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirmer le mot de passe <span class="req">*</span></label>
                        <input type="password" class="form-input" id="reg-password2" required>
                    </div>
                    
                    <div style="display:flex;gap:0.5rem;margin-top:1rem;">
                        <button type="button" class="btn btn-ghost" onclick="prevRegStep()" style="color:var(--gray-700);">‚Üê Retour</button>
                        <button type="submit" class="form-submit" style="flex:1;margin:0;">Cr√©er mon compte</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- DASHBOARD -->
    <div id="dashboard-view" class="hidden"></div>
</main>

<!-- FORGOT PASSWORD MODAL -->
<div class="modal-overlay" id="forgot-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>üîê Mot de passe oubli√©</h3>
            <button class="modal-close" onclick="closeForgotPw()">√ó</button>
        </div>
        <div id="forgot-alert"></div>
        <form onsubmit="resetPassword(event)">
            <div class="form-group">
                <label class="form-label">Email de votre compte</label>
                <input type="email" class="form-input" id="forgot-email" required placeholder="votre@email.com">
            </div>
            <button type="submit" class="form-submit">Envoyer le lien</button>
        </form>
    </div>
</div>

<script>
// ========== CONFIGURATION ==========
const PROMOS = [
    // ES - √âducateur Sp√©cialis√©
    { id: 'ES1-LM', name: 'ES1 Louise Michel', formation: 'ES', annee: 1, site: 'SLB' },
    { id: 'ES1-FD', name: 'ES1 Fernand Deligny', formation: 'ES', annee: 1, site: 'SLB' },
    { id: 'ES2-SLB', name: 'ES2 Saint-Laurent-Blangy', formation: 'ES', annee: 2, site: 'SLB' },
    { id: 'ES2-AV', name: 'ES2 Avion', formation: 'ES', annee: 2, site: 'Avion' },
    { id: 'ES3-SLB', name: 'ES3 Saint-Laurent-Blangy', formation: 'ES', annee: 3, site: 'SLB' },
    { id: 'ES3-AV', name: 'ES3 Avion', formation: 'ES', annee: 3, site: 'Avion' },
    
    // ME - Moniteur √âducateur
    { id: 'ME1-LM', name: 'ME1 Louise Michel', formation: 'ME', annee: 1, site: 'SLB' },
    { id: 'ME1-FD', name: 'ME1 Fernand Deligny', formation: 'ME', annee: 1, site: 'SLB' },
    { id: 'ME2-SLB', name: 'ME2 Saint-Laurent-Blangy', formation: 'ME', annee: 2, site: 'SLB' },
    { id: 'ME2-AV', name: 'ME2 Avion', formation: 'ME', annee: 2, site: 'Avion' },
    
    // AES - Accompagnant √âducatif et Social
    { id: 'AES1-SLB', name: 'AES1 Saint-Laurent-Blangy', formation: 'AES', annee: 1, site: 'SLB' },
    { id: 'AES1-AV', name: 'AES1 Avion', formation: 'AES', annee: 1, site: 'Avion' },
    { id: 'AES2-SLB', name: 'AES2 Saint-Laurent-Blangy', formation: 'AES', annee: 2, site: 'SLB' },
    { id: 'AES2-AV', name: 'AES2 Avion', formation: 'AES', annee: 2, site: 'Avion' },
    
    // CAFERUIS
    { id: 'CAFERUIS1', name: 'CAFERUIS Ann√©e 1', formation: 'CAFERUIS', annee: 1, site: 'SLB' },
    { id: 'CAFERUIS2', name: 'CAFERUIS Ann√©e 2', formation: 'CAFERUIS', annee: 2, site: 'SLB' },
    
    // CAFDES
    { id: 'CAFDES1', name: 'CAFDES Ann√©e 1', formation: 'CAFDES', annee: 1, site: 'SLB' },
    { id: 'CAFDES2', name: 'CAFDES Ann√©e 2', formation: 'CAFDES', annee: 2, site: 'SLB' }
];

const SITES = { 'SLB': 'Saint-Laurent-Blangy', 'Avion': 'Avion' };
const FORMATIONS = { 'ES': '√âducateur Sp√©cialis√©', 'ME': 'Moniteur √âducateur', 'AES': 'Accompagnant √âducatif et Social', 'CAFERUIS': 'CAFERUIS', 'CAFDES': 'CAFDES' };
const FORMATION_COLORS = { 'ES': 'tag-es', 'ME': 'tag-me', 'AES': 'tag-aes', 'CAFERUIS': 'tag-caferuis', 'CAFDES': 'tag-cafdes' };
const ANNEE_SCOLAIRE = '2024-2025';

// ========== STORAGE ==========
const get = k => JSON.parse(localStorage.getItem('af_'+k) || '[]');
const set = (k, v) => localStorage.setItem('af_'+k, JSON.stringify(v));
const getOne = k => JSON.parse(localStorage.getItem('af_'+k) || 'null');
const setOne = (k, v) => localStorage.setItem('af_'+k, JSON.stringify(v));

// ========== UTILS ==========
const $ = id => document.getElementById(id);
const formatDate = d => new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
const today = () => new Date().toISOString().split('T')[0];
const hash = s => { let h=0; for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h=h&h;} return 'h_'+Math.abs(h).toString(16); };
const gradeClass = v => v >= 14 ? 'grade-good' : v >= 10 ? 'grade-ok' : 'grade-bad';
const getPromo = id => PROMOS.find(p => p.id === id);
const showAlert = (id, type, msg) => $(id).innerHTML = `<div class="alert alert-${type}">${msg}</div>`;

// ========== INIT DATA ==========
function initData() {
    if (!get('users').length) {
        set('users', [{ id: 1, type: 'admin', email: 'admin@afertes.org', password: hash('Admin123'), prenom: 'Admin', nom: 'AFERTES', sites: ['SLB', 'Avion'] }]);
    }
    if (!get('news').length) {
        set('news', [
            { id: 1, title: 'Bienvenue sur le portail AFERTES', content: 'Le nouveau portail de formation est en ligne ! Cr√©ez votre compte pour acc√©der √† toutes les fonctionnalit√©s.', date: today(), author: 'Administration', priority: 'important', promos: [], image: '' },
            { id: 2, title: 'Rentr√©e 2024-2025', content: 'Nous souhaitons la bienvenue √† tous les √©tudiants pour cette nouvelle ann√©e de formation.', date: '2024-09-02', author: 'Direction', priority: 'normal', promos: [], image: '' }
        ]);
    }
    
    // Populate promo select
    const sel = $('reg-promo');
    if (sel) {
        sel.innerHTML = '<option value="">S√©lectionnez votre promotion...</option>';
        let currentFormation = '';
        PROMOS.forEach(p => {
            if (p.formation !== currentFormation) {
                if (currentFormation) sel.innerHTML += '</optgroup>';
                sel.innerHTML += `<optgroup label="${FORMATIONS[p.formation]}">`;
                currentFormation = p.formation;
            }
            sel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
        });
        sel.innerHTML += '</optgroup>';
    }
}

// ========== AUTH ==========
let selectedType = null;
let currentUser = null;

function showAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', tab === 'login' ? i===0 : i===1));
    $('login-form').classList.toggle('active', tab === 'login');
    $('register-form').classList.toggle('active', tab === 'register');
    $('auth-alert').innerHTML = '';
    if (tab === 'register') {
        $('reg-step1').classList.remove('hidden');
        $('reg-step2').classList.add('hidden');
        selectedType = null;
        document.querySelectorAll('[data-type]').forEach(el => el.style.borderColor = '');
        $('next-btn').disabled = true;
    }
}

function selectUserType(type) {
    selectedType = type;
    document.querySelectorAll('[data-type]').forEach(el => {
        el.style.borderColor = el.dataset.type === type ? 'var(--blue)' : '';
        el.style.background = el.dataset.type === type ? '#dbeafe' : '';
    });
    $('next-btn').disabled = false;
}

function nextRegStep() {
    if (!selectedType) return;
    $('reg-step1').classList.add('hidden');
    $('reg-step2').classList.remove('hidden');
    $('student-fields').classList.toggle('hidden', selectedType !== 'student');
    $('teacher-fields').classList.toggle('hidden', selectedType !== 'teacher');
    $('reg-promo').required = selectedType === 'student';
}

function prevRegStep() {
    $('reg-step1').classList.remove('hidden');
    $('reg-step2').classList.add('hidden');
}

function toggleChip(chip) { chip.classList.toggle('selected'); }
function getSelectedChips(containerId) { return Array.from(document.querySelectorAll('#'+containerId+' .chip.selected')).map(c => c.dataset.val); }

function login(e) {
    e.preventDefault();
    const email = $('login-email').value.trim().toLowerCase();
    const password = $('login-password').value;
    const users = get('users');
    const user = users.find(u => u.email.toLowerCase() === email);
    if (!user) return showAlert('auth-alert', 'error', '‚ùå Aucun compte avec cet email');
    if (user.password !== hash(password)) return showAlert('auth-alert', 'error', '‚ùå Mot de passe incorrect');
    setOne('session', user);
    currentUser = user;
    showDashboard();
}

function register(e) {
    e.preventDefault();
    const email = $('reg-email').value.trim().toLowerCase();
    const password = $('reg-password').value;
    const password2 = $('reg-password2').value;
    
    if (password !== password2) return showAlert('auth-alert', 'error', '‚ùå Les mots de passe ne correspondent pas');
    if (password.length < 6) return showAlert('auth-alert', 'error', '‚ùå Le mot de passe doit faire au moins 6 caract√®res');
    
    const users = get('users');
    if (users.find(u => u.email.toLowerCase() === email)) return showAlert('auth-alert', 'error', '‚ùå Cet email est d√©j√† utilis√©');
    
    const newUser = {
        id: Date.now(),
        type: selectedType,
        email,
        password: hash(password),
        prenom: $('reg-prenom').value.trim(),
        nom: $('reg-nom').value.trim(),
        tel: $('reg-tel').value.trim(),
        photo: null
    };
    
    if (selectedType === 'student') {
        newUser.promo = $('reg-promo').value;
    } else {
        newUser.sites = getSelectedChips('teacher-sites');
    }
    
    users.push(newUser);
    set('users', users);
    setOne('session', newUser);
    currentUser = newUser;
    showAlert('auth-alert', 'success', '‚úÖ Compte cr√©√© ! Redirection...');
    setTimeout(showDashboard, 1000);
}

function showForgotPw() { $('forgot-modal').classList.add('active'); }
function closeForgotPw() { $('forgot-modal').classList.remove('active'); }

function resetPassword(e) {
    e.preventDefault();
    const email = $('forgot-email').value.trim().toLowerCase();
    const users = get('users');
    const user = users.find(u => u.email.toLowerCase() === email);
    if (!user) return showAlert('forgot-alert', 'error', '‚ùå Aucun compte avec cet email');
    const newPw = 'Afertes' + Math.floor(Math.random() * 10000);
    user.password = hash(newPw);
    set('users', users);
    showAlert('forgot-alert', 'success', `‚úÖ Nouveau mot de passe : <strong>${newPw}</strong><br><small>Notez-le et changez-le dans les param√®tres.</small>`);
}

function logout() {
    localStorage.removeItem('af_session');
    currentUser = null;
    $('auth-view').classList.remove('hidden');
    $('dashboard-view').classList.add('hidden');
    $('header-user').innerHTML = '';
    showAuthTab('login');
}

// ========== DASHBOARD ==========
function showDashboard() {
    $('auth-view').classList.add('hidden');
    $('dashboard-view').classList.remove('hidden');
    $('header-user').innerHTML = `
        <span style="font-size:0.9rem;">${currentUser.prenom}</span>
        <button class="btn btn-pink" onclick="logout()">D√©connexion</button>
    `;
    renderDashboard();
}

function renderDashboard() {
    const isStudent = currentUser.type === 'student';
    const isTeacher = currentUser.type === 'teacher' || currentUser.type === 'admin';
    const promo = isStudent ? getPromo(currentUser.promo) : null;
    
    let badges = '';
    if (promo) {
        badges = `<span class="badge badge-light">${promo.name}</span>
                  <span class="badge badge-light">${SITES[promo.site]}</span>
                  <span class="badge badge-light">${ANNEE_SCOLAIRE}</span>`;
    } else if (currentUser.sites?.length) {
        badges = currentUser.sites.map(s => `<span class="badge badge-light">üìç ${SITES[s]}</span>`).join('');
    }
    
    $('dashboard-view').innerHTML = `
        <div class="welcome">
            <h1>Bonjour ${currentUser.prenom} üëã</h1>
            <p>${isStudent ? 'Bienvenue dans votre espace √©tudiant' : 'Bienvenue dans votre espace formateur'}</p>
            <div class="welcome-badges">${badges}</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-tab="home">üè† Accueil</button>
            ${isStudent ? '<button class="tab" data-tab="profile">üë§ Profil</button>' : ''}
            ${isStudent ? '<button class="tab" data-tab="grades">üìä Notes</button>' : ''}
            ${isStudent ? '<button class="tab" data-tab="schedule">üìÖ EDT</button>' : ''}
            ${isTeacher ? '<button class="tab" data-tab="news-manage">üì∞ Actualit√©s</button>' : ''}
            ${isTeacher ? '<button class="tab" data-tab="grades-manage">üìä Notes</button>' : ''}
            ${isTeacher ? '<button class="tab" data-tab="students">üë• √âtudiants</button>' : ''}
            <button class="tab" data-tab="settings">‚öôÔ∏è Param√®tres</button>
        </div>
        
        <div id="tab-home" class="tab-content active">${renderHome()}</div>
        ${isStudent ? `<div id="tab-profile" class="tab-content">${renderProfile()}</div>` : ''}
        ${isStudent ? `<div id="tab-grades" class="tab-content">${renderStudentGrades()}</div>` : ''}
        ${isStudent ? `<div id="tab-schedule" class="tab-content">${renderStudentSchedule()}</div>` : ''}
        ${isTeacher ? `<div id="tab-news-manage" class="tab-content">${renderNewsManage()}</div>` : ''}
        ${isTeacher ? `<div id="tab-grades-manage" class="tab-content">${renderGradesManage()}</div>` : ''}
        ${isTeacher ? `<div id="tab-students" class="tab-content">${renderStudents()}</div>` : ''}
        <div id="tab-settings" class="tab-content">${renderSettings()}</div>
    `;
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
        tab.onclick = () => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            $('tab-' + tab.dataset.tab).classList.add('active');
        };
    });
}

function switchTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === name));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    $('tab-' + name)?.classList.add('active');
}

// ========== RENDER FUNCTIONS ==========
function renderHome() {
    const news = get('news').slice(0, 5);
    const isStudent = currentUser.type === 'student';
    
    return `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1rem;">
            <div class="card">
                <div class="card-header"><span class="card-title">‚ö° Actions rapides</span></div>
                <div class="quick-grid">
                    ${isStudent ? `
                        <div class="quick-btn" onclick="switchTab('profile')"><div class="icon">üë§</div><div class="label">Mon profil</div></div>
                        <div class="quick-btn" onclick="switchTab('grades')"><div class="icon">üìä</div><div class="label">Mes notes</div></div>
                        <div class="quick-btn" onclick="switchTab('schedule')"><div class="icon">üìÖ</div><div class="label">Mon EDT</div></div>
                    ` : `
                        <div class="quick-btn" onclick="switchTab('news-manage')"><div class="icon">üì∞</div><div class="label">Actualit√©s</div></div>
                        <div class="quick-btn" onclick="switchTab('grades-manage')"><div class="icon">üìä</div><div class="label">Notes</div></div>
                        <div class="quick-btn" onclick="switchTab('students')"><div class="icon">üë•</div><div class="label">√âtudiants</div></div>
                    `}
                    <div class="quick-btn" onclick="switchTab('settings')"><div class="icon">‚öôÔ∏è</div><div class="label">Param√®tres</div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><span class="card-title">üì∞ Actualit√©s</span></div>
                ${news.map(n => `
                    <div class="news-item">
                        ${n.image ? `<img src="${n.image}" class="news-img" onerror="this.style.display='none'">` : ''}
                        <div class="news-title">${n.priority==='urgent'?'üî¥':n.priority==='important'?'üü†':''} ${n.title}</div>
                        <div class="news-content">${n.content.substring(0,100)}${n.content.length>100?'...':''}</div>
                        <div class="news-meta">${formatDate(n.date)} ‚Ä¢ ${n.author}</div>
                        <div style="clear:both;"></div>
                    </div>
                `).join('') || '<p class="list-empty">Aucune actualit√©</p>'}
            </div>
        </div>
    `;
}

function renderProfile() {
    const promo = getPromo(currentUser.promo);
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üë§ Mon Profil</span></div>
            <div id="profile-alert"></div>
            <div class="profile-header">
                <div class="avatar" id="avatar-display">${currentUser.photo ? `<img src="${currentUser.photo}">` : currentUser.prenom[0]+currentUser.nom[0]}</div>
                <div class="profile-info">
                    <h3>${currentUser.prenom} ${currentUser.nom}</h3>
                    <p>${currentUser.email}</p>
                    <p>${promo ? `<span class="tag ${FORMATION_COLORS[promo.formation]}">${promo.name}</span>` : ''}</p>
                </div>
            </div>
            <form onsubmit="saveProfile(event)" class="profile-form">
                <div class="form-group"><label class="form-label">Pr√©nom</label><input type="text" class="form-input" id="prof-prenom" value="${currentUser.prenom}" required></div>
                <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="prof-nom" value="${currentUser.nom}" required></div>
                <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="prof-email" value="${currentUser.email}" required></div>
                <div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="prof-tel" value="${currentUser.tel||''}"></div>
                <div style="grid-column:1/-1;"><button type="submit" class="btn btn-blue">üíæ Enregistrer</button></div>
            </form>
        </div>
    `;
}

function saveProfile(e) {
    e.preventDefault();
    const users = get('users');
    const idx = users.findIndex(u => u.id === currentUser.id);
    if (idx === -1) return;
    users[idx].prenom = $('prof-prenom').value;
    users[idx].nom = $('prof-nom').value;
    users[idx].email = $('prof-email').value;
    users[idx].tel = $('prof-tel').value;
    set('users', users);
    currentUser = users[idx];
    setOne('session', currentUser);
    showAlert('profile-alert', 'success', '‚úÖ Profil mis √† jour !');
    $('header-user').querySelector('span').textContent = currentUser.prenom;
}

function renderStudentGrades() {
    const grades = get('grades').filter(g => g.studentId === currentUser.id);
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üìä Mes Notes</span></div>
            ${grades.length ? `
                <table>
                    <thead><tr><th>Mati√®re</th><th>Note</th><th>Coef</th><th>Date</th><th>Commentaire</th></tr></thead>
                    <tbody>${grades.map(g => `
                        <tr>
                            <td>${g.subject}</td>
                            <td><span class="grade ${gradeClass(g.value)}">${g.value}/20</span></td>
                            <td>${g.coef}</td>
                            <td>${formatDate(g.date)}</td>
                            <td>${g.comment||'-'}</td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p class="list-empty">Aucune note pour le moment</p>'}
        </div>
    `;
}

function renderStudentSchedule() {
    const promo = getPromo(currentUser.promo);
    const schedules = get('schedules').filter(s => !s.promo || s.promo === currentUser.promo);
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üìÖ Emploi du Temps</span></div>
            ${schedules.length ? schedules.map(s => `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">üìÑ</span>
                        <div>
                            <strong>${s.name}</strong>
                            <p style="font-size:0.75rem;color:var(--gray-500);">${formatDate(s.date)}</p>
                        </div>
                    </div>
                </div>
            `).join('') : '<p class="list-empty">Aucun emploi du temps disponible</p>'}
        </div>
    `;
}

function renderNewsManage() {
    const news = get('news');
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üì∞ G√©rer les Actualit√©s</span></div>
            
            <div style="background:var(--gray-50);padding:1rem;border-radius:8px;margin-bottom:1rem;">
                <div class="img-upload">
                    <div class="img-preview" id="news-img-preview">üì∑</div>
                    <div>
                        <label class="img-upload-btn">
                            Ajouter une image
                            <input type="file" accept="image/*" onchange="previewNewsImg(this)">
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="news-title" placeholder="Titre de l'actualit√©"></div>
                    <div class="form-group"><label class="form-label">Priorit√©</label><select class="form-select" id="news-priority"><option value="normal">Normale</option><option value="important">Importante üü†</option><option value="urgent">Urgente üî¥</option></select></div>
                </div>
                <div class="form-group"><label class="form-label">Contenu</label><textarea class="form-input" id="news-content" rows="3" placeholder="Contenu..."></textarea></div>
                <div class="form-group">
                    <label class="form-label">Promotions concern√©es (laisser vide = toutes)</label>
                    <div class="chips" id="news-promos">
                        ${PROMOS.map(p => `<span class="chip" data-val="${p.id}" onclick="toggleChip(this)">${p.name}</span>`).join('')}
                    </div>
                </div>
                <button class="btn btn-green" onclick="addNews()">üì∞ Publier</button>
            </div>
            
            <h4 style="margin:1rem 0 0.5rem;color:var(--blue);">Actualit√©s publi√©es</h4>
            ${news.map(n => `
                <div class="news-item" style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;">
                    <div style="flex:1;">
                        <div class="news-title">${n.priority==='urgent'?'üî¥':n.priority==='important'?'üü†':''} ${n.title}</div>
                        <div class="news-content">${n.content}</div>
                        <div class="news-meta">${formatDate(n.date)} ${n.promos?.length ? n.promos.map(p => getPromo(p)?.name || p).join(', ') : 'Toutes les promos'}</div>
                    </div>
                    <button class="btn btn-delete" onclick="deleteNews(${n.id})">üóëÔ∏è</button>
                </div>
            `).join('')}
        </div>
    `;
}

let newsImgData = '';
function previewNewsImg(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
            newsImgData = e.target.result;
            $('news-img-preview').innerHTML = `<img src="${newsImgData}">`;
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function addNews() {
    const title = $('news-title').value.trim();
    const content = $('news-content').value.trim();
    if (!title || !content) return alert('Veuillez remplir le titre et le contenu');
    const news = get('news');
    news.unshift({
        id: Date.now(),
        title,
        content,
        date: today(),
        author: currentUser.prenom + ' ' + currentUser.nom,
        priority: $('news-priority').value,
        promos: getSelectedChips('news-promos'),
        image: newsImgData
    });
    set('news', news);
    newsImgData = '';
    renderDashboard();
    switchTab('news-manage');
}

function deleteNews(id) {
    if (!confirm('Supprimer cette actualit√© ?')) return;
    set('news', get('news').filter(n => n.id !== id));
    renderDashboard();
    switchTab('news-manage');
}

function renderGradesManage() {
    const students = get('users').filter(u => u.type === 'student');
    const grades = get('grades');
    
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üìä Attribuer des Notes</span></div>
            
            <div style="background:var(--gray-50);padding:1rem;border-radius:8px;margin-bottom:1rem;">
                <div class="form-group">
                    <label class="form-label">Promotion</label>
                    <select class="form-select" id="grade-filter-promo" onchange="updateStudentSelect()">
                        <option value="">Toutes les promotions</option>
                        ${PROMOS.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">√âtudiant</label><select class="form-select" id="grade-student"></select></div>
                    <div class="form-group"><label class="form-label">Mati√®re</label><input type="text" class="form-input" id="grade-subject" placeholder="Ex: Communication"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Note /20</label><input type="number" class="form-input" id="grade-value" min="0" max="20" step="0.5"></div>
                    <div class="form-group"><label class="form-label">Coefficient</label><input type="number" class="form-input" id="grade-coef" value="1" min="1" max="10"></div>
                </div>
                <div class="form-group"><label class="form-label">Commentaire</label><input type="text" class="form-input" id="grade-comment" placeholder="Optionnel"></div>
                <button class="btn btn-green" onclick="addGrade()">üìù Enregistrer la note</button>
            </div>
            
            <h4 style="margin:1rem 0 0.5rem;color:var(--blue);">Notes attribu√©es</h4>
            <table>
                <thead><tr><th>√âtudiant</th><th>Promo</th><th>Mati√®re</th><th>Note</th><th>Date</th><th></th></tr></thead>
                <tbody>
                    ${grades.map(g => {
                        const s = students.find(st => st.id === g.studentId);
                        const p = s ? getPromo(s.promo) : null;
                        return `<tr>
                            <td>${s ? s.prenom+' '+s.nom : '?'}</td>
                            <td>${p ? `<span class="tag ${FORMATION_COLORS[p.formation]}">${p.name}</span>` : ''}</td>
                            <td>${g.subject}</td>
                            <td><span class="grade ${gradeClass(g.value)}">${g.value}/20</span></td>
                            <td>${formatDate(g.date)}</td>
                            <td><button class="btn btn-delete" onclick="deleteGrade(${g.id})">üóëÔ∏è</button></td>
                        </tr>`;
                    }).join('') || '<tr><td colspan="6" class="list-empty">Aucune note</td></tr>'}
                </tbody>
            </table>
        </div>
    `;
}

function updateStudentSelect() {
    const promo = $('grade-filter-promo')?.value;
    const students = get('users').filter(u => u.type === 'student' && (!promo || u.promo === promo));
    const sel = $('grade-student');
    if (sel) {
        sel.innerHTML = '<option value="">S√©lectionnez un √©tudiant...</option>' + 
            students.map(s => {
                const p = getPromo(s.promo);
                return `<option value="${s.id}">${s.prenom} ${s.nom}${p ? ' ('+p.name+')' : ''}</option>`;
            }).join('');
    }
}

function addGrade() {
    const studentId = parseInt($('grade-student').value);
    const subject = $('grade-subject').value.trim();
    const value = parseFloat($('grade-value').value);
    if (!studentId || !subject || isNaN(value)) return alert('Veuillez remplir tous les champs obligatoires');
    const grades = get('grades');
    grades.unshift({
        id: Date.now(),
        studentId,
        subject,
        value,
        coef: parseInt($('grade-coef').value) || 1,
        date: today(),
        comment: $('grade-comment').value.trim()
    });
    set('grades', grades);
    $('grade-subject').value = '';
    $('grade-value').value = '';
    $('grade-comment').value = '';
    renderDashboard();
    switchTab('grades-manage');
}

function deleteGrade(id) {
    if (!confirm('Supprimer cette note ?')) return;
    set('grades', get('grades').filter(g => g.id !== id));
    renderDashboard();
    switchTab('grades-manage');
}

function renderStudents() {
    const students = get('users').filter(u => u.type === 'student');
    const grades = get('grades');
    
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">üë• Liste des √âtudiants (${students.length})</span></div>
            
            <div class="filters">
                <div class="filter-group">
                    <label>Promotion :</label>
                    <select class="form-select" id="filter-promo" onchange="filterStudentsList()">
                        <option value="">Toutes</option>
                        ${PROMOS.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                    </select>
                </div>
            </div>
            
            <div id="students-list">
                ${students.map(s => {
                    const p = getPromo(s.promo);
                    const sg = grades.filter(g => g.studentId === s.id);
                    const avg = sg.length ? (sg.reduce((sum,g)=>sum+g.value*g.coef,0) / sg.reduce((sum,g)=>sum+g.coef,0)).toFixed(1) : '-';
                    return `
                        <div class="list-item" data-promo="${s.promo}">
                            <div style="display:flex;align-items:center;gap:0.75rem;">
                                <div class="avatar" style="width:45px;height:45px;font-size:0.9rem;">${s.prenom[0]}${s.nom[0]}</div>
                                <div>
                                    <strong>${s.prenom} ${s.nom}</strong><br>
                                    <span class="tag ${p?FORMATION_COLORS[p.formation]:''}">${p?.name||'-'}</span>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <span class="grade ${avg!=='-'?gradeClass(parseFloat(avg)):''}">${avg!=='-'?avg+'/20':'--'}</span><br>
                                <small style="color:var(--gray-500);">${sg.length} note(s)</small>
                            </div>
                        </div>
                    `;
                }).join('') || '<p class="list-empty">Aucun √©tudiant inscrit</p>'}
            </div>
        </div>
    `;
}

function filterStudentsList() {
    const promo = $('filter-promo').value;
    document.querySelectorAll('#students-list .list-item').forEach(item => {
        item.style.display = !promo || item.dataset.promo === promo ? '' : 'none';
    });
}

function renderSettings() {
    return `
        <div class="card">
            <div class="card-header"><span class="card-title">‚öôÔ∏è Param√®tres</span></div>
            
            <div class="settings-section">
                <h4>üîê Changer le mot de passe</h4>
                <div id="pw-alert"></div>
                <form onsubmit="changePassword(event)">
                    <div class="form-group"><label class="form-label">Mot de passe actuel</label><input type="password" class="form-input" id="pw-current" required></div>
                    <div class="form-group"><label class="form-label">Nouveau mot de passe</label><input type="password" class="form-input" id="pw-new" required minlength="6"></div>
                    <div class="form-group"><label class="form-label">Confirmer</label><input type="password" class="form-input" id="pw-confirm" required></div>
                    <button type="submit" class="btn btn-blue">Changer le mot de passe</button>
                </form>
            </div>
            
            <div class="settings-section">
                <h4>üìß Email de r√©cup√©ration</h4>
                <p style="color:var(--gray-500);">Votre email : <strong>${currentUser.email}</strong></p>
            </div>
            
            ${currentUser.type === 'teacher' || currentUser.type === 'admin' ? `
                <div class="settings-section">
                    <h4>üìç Mes sites d'intervention</h4>
                    <div class="chips" id="settings-sites">
                        ${Object.entries(SITES).map(([k,v]) => `<span class="chip ${currentUser.sites?.includes(k)?'selected':''}" data-val="${k}" onclick="toggleChip(this)">üìç ${v}</span>`).join('')}
                    </div>
                    <button class="btn btn-blue" style="margin-top:1rem;" onclick="saveSites()">Enregistrer les sites</button>
                </div>
            ` : ''}
        </div>
    `;
}

function changePassword(e) {
    e.preventDefault();
    const current = $('pw-current').value;
    const newPw = $('pw-new').value;
    const confirm = $('pw-confirm').value;
    
    if (hash(current) !== currentUser.password) return showAlert('pw-alert', 'error', '‚ùå Mot de passe actuel incorrect');
    if (newPw.length < 6) return showAlert('pw-alert', 'error', '‚ùå Le nouveau mot de passe doit faire au moins 6 caract√®res');
    if (newPw !== confirm) return showAlert('pw-alert', 'error', '‚ùå Les mots de passe ne correspondent pas');
    
    const users = get('users');
    const idx = users.findIndex(u => u.id === currentUser.id);
    users[idx].password = hash(newPw);
    set('users', users);
    currentUser = users[idx];
    setOne('session', currentUser);
    showAlert('pw-alert', 'success', '‚úÖ Mot de passe modifi√© !');
    e.target.reset();
}

function saveSites() {
    const sites = getSelectedChips('settings-sites');
    const users = get('users');
    const idx = users.findIndex(u => u.id === currentUser.id);
    users[idx].sites = sites;
    set('users', users);
    currentUser = users[idx];
    setOne('session', currentUser);
    alert('Sites enregistr√©s !');
}

// ========== INIT ==========
initData();
updateStudentSelect();

// Check session
const session = getOne('session');
if (session) {
    const users = get('users');
    const user = users.find(u => u.id === session.id);
    if (user) {
        currentUser = user;
        showDashboard();
    }
}

// Service Worker
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>

</body>
</html>
